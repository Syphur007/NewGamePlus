
import React, { useState, useEffect, useCallback } from "react";
import { User, Match, Game, MatchRequest } from "@/entities/all";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Users2, MessageSquare, X, Calendar, Search, Users, Mail, Send } from "lucide-react";
import SchedulePlayDateDialog from "../components/matches/SchedulePlayDateDialog";
import { toast, Toaster } from "sonner";
import MatchRequestCard from "../components/matches/MatchRequestCard";

export default function MatchesPage() {
  const [currentUser, setCurrentUser] = useState(null);
  const [matches, setMatches] = useState([]);
  const [matchRequests, setMatchRequests] = useState([]);
  const [users, setUsers] = useState({});
  const [isLoading, setIsLoading] = useState(true);
  const [showScheduleDialog, setShowScheduleDialog] = useState(false);
  const [selectedMatch, setSelectedMatch] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");

  const loadData = useCallback(async () => {
    setIsLoading(true);
    try {
      const me = await User.me();
      setCurrentUser(me);

      const [allMatches, allRequests, allUsers] = await Promise.all([
        Match.filter({ $or: [{ user_id: me.id }, { matched_user_id: me.id }] }),
        MatchRequest.filter({ $or: [{ requester_id: me.id }, { requested_id: me.id }] }),
        User.list()
 